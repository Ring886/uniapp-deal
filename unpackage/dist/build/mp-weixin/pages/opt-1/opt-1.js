"use strict";const e=require("../../common/vendor.js"),s=require("../../common/assets.js"),o={__name:"opt-1",setup(o){const a=e.ref([]),t=e.ref([]),n=e.ref(""),l=e.computed((()=>0===t.value.length||""===n.value.trim()));const i=()=>{e.index.chooseImage({count:1,success:e=>{e.tempFilePaths.forEach((e=>{c(e)}))},fail:e=>{console.error("选择图片失败")}})},c=s=>{e.index.compressImage({src:s,quality:10,success:e=>{t.value.push(e.tempFilePath)},fail:e=>{console.error("压缩失败:",e)}})},u=s=>new Promise(((o,a)=>{e.index.uploadFile({url:"https://dwdeal.cn/item/upload",filePath:s,name:"file",success:e=>{const s=JSON.parse(e.data);s.filePath?o(`https://dwdeal.cn/${s.filePath}`):a("文件路径不存在")},fail:e=>{console.error("上传失败:",e),a(e)}})})),r=function(s,o){const a=e.ref(null);return function(...e){a.value&&clearTimeout(a.value),a.value=setTimeout((()=>{s(...e)}),o)}}((async()=>{if(e.index.showLoading({title:"加载中"}),t.value.length>0){a.value.push(...t.value);for(let e=0;e<a.value.length;e++)a.value[e]=await u(a.value[e]);console.log(a.value);const s=e.ref(e.index.getStorageSync("success"));e.index.request({url:"https://dwdeal.cn/item/submit",method:"POST",data:{name:s.value[0],id:s.value[2],detail:n.value,images:a.value,views:0,date:(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",hour12:!1})},success:s=>{e.index.showToast({title:"发布成功!",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1e3)},fail:e=>{console.error("提交失败:",e)}})}else console.warn("请选择图片");e.index.hideLoading()}),1e3);return e.onShow((()=>{try{e.index.getStorageInfo({success:s=>{e.index.getStorageSync("success")?console.log("有缓存"):e.index.redirectTo({url:"/pages/user/login"})}})}catch(s){console.log("获取缓存失败")}})),(o,a)=>({a:n.value,b:e.o((e=>n.value=e.detail.value)),c:e.f(t.value,((s,o,a)=>({a:s,b:s,c:e.o((s=>function(s){e.index.showActionSheet({itemList:["删除"],success:function(e){t.value.splice(s,1)},fail:function(e){console.log(e.errMsg)}})}(o)),s)}))),d:s._imports_0$1,e:e.o(i),f:e.o(((...s)=>e.unref(r)&&e.unref(r)(...s))),g:l.value})}},a=e._export_sfc(o,[["__scopeId","data-v-e4a4c8a3"]]);wx.createPage(a);
