"use strict";const o=require("../../common/vendor.js");if(!Array){(o.resolveComponent("uni-collapse-item")+o.resolveComponent("uni-collapse")+o.resolveComponent("uni-popup"))()}Math||(s+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const s=()=>"../../components/my-applied/my-applied.js",a={__name:"user",setup(s){const a=o.ref([]),n=o.ref(""),t=o.ref([]);function c(){try{o.index.removeStorageSync("success"),o.index.redirectTo({url:"/pages/user/login"})}catch(e){console.log("清除缓存失败")}}function l(){o.index.showActionSheet({itemList:["修改头像","修改昵称"],success:function(e){0===e.tapIndex?o.index.chooseImage({count:1,success:e=>{i(e.tempFilePaths[0])},fail:e=>{console.error("选择图片失败")}}):p()},fail:function(e){console.log(e.errMsg)}})}a.value=o.index.getStorageSync("success");const i=s=>new Promise(((a,t)=>{o.index.compressImage({src:s,quality:10,success:e=>{n.value=e.tempFilePath,console.log("压缩成功"),a()},fail:o=>{console.error("压缩失败:",o),t(e)}})})).then((()=>{r()})).catch((e=>{console.error(e)})),r=async()=>{var e;n.value=await(e=n.value,new Promise(((s,a)=>{o.index.uploadFile({url:"https://dwdeal.cn/uploadAvator",filePath:e,name:"file",success:e=>{const o=JSON.parse(e.data);o.filePath?s(`https://dwdeal.cn/${o.filePath}`):a("图片不存在")},fail:e=>{console.error("上传失败:",e)}})}))),o.index.request({url:"https://dwdeal.cn/submitAvator",method:"POST",header:{"content-type":"application/json"},data:{id:a.value[2],avator:n.value},success:e=>{if(e.data.success)return new Promise(((e,s)=>{const t=a.value[2],c=a.value[0];o.index.setStorageSync("success",[c,n.value,t]),a.value=o.index.getStorageSync("success"),e()})).then((()=>{o.index.showToast({title:"修改成功"})})).catch((e=>{console.error("服务器超时")}));console.err("服务器错误,",e.data.message)},fail:e=>{console.error("提交失败:",e)}})},u=o.ref(null),d=o.ref(""),p=()=>{u.value.open()},m=()=>{d.value="",u.value.close()},v=()=>{console.log("输入的内容:",d.value),o.index.request({url:"https://dwdeal.cn/changeName",method:"POST",header:{"content-type":"application/json"},data:{id:a.value[2],newName:d.value},success:e=>{if(e.data.success)return new Promise(((e,s)=>{o.index.showToast({title:"修改成功"});const n=a.value[2],t=a.value[1];o.index.setStorageSync("success",[d.value,t,n]),a.value=o.index.getStorageSync("success"),e()})).then((()=>{u.value.close()})).catch((e=>{console.error("服务器超时")}));console.err("服务器错误,",e.data.message)},fail:e=>{console.error("修改失败",e)}})};function g(){return new Promise(((e,s)=>{o.index.request({url:"https://dwdeal.cn/getSelfItems",method:"POST",header:{"content-type":"application/json"},data:{id:a.value[2]},success:a=>{console.log("进入了后端"),a.data.success?(o.index.setStorageSync("myItems",a.data.myItems),t.value=o.index.getStorageSync("myItems"),console.log(t.value),e()):s({message:"服务器错啦",details:a.data.message})},fail:e=>{s({message:"读取个人发布失败",error:e})}})}))}return o.onShow((()=>{console.log("onLoad");try{o.index.getStorageInfo({success:e=>{o.index.getStorageSync("success")?console.log("有缓存"):o.index.redirectTo({url:"/pages/user/login"})}})}catch(e){console.log("获取缓存失败")}})),o.onPullDownRefresh((async()=>{await g(),o.index.stopPullDownRefresh()})),o.onLoad((async()=>{await g()})),(e,s)=>({a:a.value[1],b:o.o(l),c:o.t(a.value[0]),d:o.o(c),e:o.f(t.value,((e,s,a)=>({a:e.id,b:e.id,c:"8dd6c618-2-"+a+",8dd6c618-1",d:o.p({src:e.src,views:e.views,detail:e.detail,date:e.date,id:e.id,_id:e._id})}))),f:o.p({title:"我发布的"}),g:o.sr("collapse","8dd6c618-0"),h:o.o((o=>e.value=o)),i:o.p({modelValue:e.value}),j:d.value,k:o.o((e=>d.value=e.detail.value)),l:o.o(m),m:o.o(v),n:o.sr(u,"8dd6c618-3",{k:"popupRef"}),o:o.p({type:"center"})})}},n=o._export_sfc(a,[["__scopeId","data-v-8dd6c618"]]);wx.createPage(n);
